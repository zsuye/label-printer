This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.repomixignore
index.html
main.js
package.json
preload.js
renderer.js
repomix.config.json
style.css
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".repomixignore">
# Add patterns to ignore here, one per line
# Example:
# *.log
# tmp/
public/
.gitignore
.gitattributes
.env
config.ini
natapp.exe
data/
services/prompt-template.txt
start_ai_bazi.bat
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标签打印器</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- 左侧标签列表 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>标签列表</h2>
                <div class="sidebar-actions">
                    <button id="addLabelBtn" class="btn btn-primary">新增标签</button>
                    <button id="importBtn" class="btn">导入</button>
                    <button id="exportBtn" class="btn">导出</button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索标签...">
            </div>
            <div id="labelList" class="label-list"></div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <div id="welcomeView" class="welcome-view">
                <h2>欢迎使用标签打印器</h2>
                <p>请从左侧选择一个标签开始编辑，或创建新标签</p>
            </div>

            <div id="editorView" class="editor-view" style="display: none;">
                <!-- 编辑区 -->
                <div class="editor-panel">
                    <h3>标签内容编辑</h3>
                    <form id="labelForm">
                        <div class="form-group">
                            <label>品名 *</label>
                            <input type="text" id="productName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>配料</label>
                            <textarea id="ingredients" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>产品标准号</label>
                            <input type="text" id="standardNo">
                        </div>
                        
                        <div class="form-group">
                            <label>生产许可证号</label>
                            <input type="text" id="licenseNo">
                        </div>
                        
                        <div class="form-group">
                            <label>保质期</label>
                            <select id="shelfLifeType">
                                <option value="normal">常温保存</option>
                                <option value="normalWithCold">常温保存，开封后冷藏</option>
                                <option value="normalWithFrozen">常温保存，开封后冷冻</option>
                                <option value="frozen">仅冷冻保存</option>
                                <option value="dual">常温/冷冻双重保存</option>
                            </select>
                            <div id="shelfLifeInputs" class="shelf-life-inputs">
                                <input type="number" id="normalDays" placeholder="常温天数" min="1">
                                <input type="number" id="frozenDays" placeholder="冷冻天数" min="1" style="display:none;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>净含量</label>
                            <input type="text" id="netContent">
                        </div>
                        
                        <div class="form-group">
                            <label>箱规（可选）</label>
                            <input type="text" id="boxSpec">
                        </div>
                        
                        <div class="form-group">
                            <label>产地</label>
                            <input type="text" id="origin">
                        </div>
                        
                        <div class="form-group">
                            <label>食用方法</label>
                            <textarea id="usage" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>生产商</label>
                            <input type="text" id="manufacturer">
                        </div>
                        
                        <div class="form-group">
                            <label>联系电话</label>
                            <input type="text" id="phone">
                        </div>
                        
                        <div class="form-group">
                            <label>地址</label>
                            <input type="text" id="address">
                        </div>
                        
                        <div class="form-group">
                            <label>致敏物质提示（可选）</label>
                            <input type="text" id="allergen">
                        </div>
                        
                        <div class="form-group">
                            <label>温馨提示（可选）</label>
                            <textarea id="tips" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>营养成分表（上传图片）</label>
                            <input type="file" id="nutritionImage" accept="image/*">
                            <div id="nutritionPreview" class="image-preview"></div>
                        </div>
                        
                        <!-- 额外字段 -->
                        <div class="form-group">
                            <label>额外字段</label>
                            <div id="extraFields"></div>
                            <button type="button" id="addExtraFieldBtn" class="btn btn-small">添加字段</button>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">保存标签</button>
                            <button type="button" id="deleteLabelBtn" class="btn btn-danger">删除标签</button>
                        </div>
                    </form>
                </div>

                <!-- 预览和打印区 -->
                <div class="preview-panel">
                    <h3>打印设置</h3>
                    
                    <div class="print-settings">
                        <div class="form-group">
                            <label>生产日期 *</label>
                            <input type="date" id="productionDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>打印机</label>
                            <select id="printerSelect">
                                <option value="">选择打印机...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>纸张大小</label>
                            <select id="paperSize">
                                <option value="76x130mm">76x130mm（默认）</option>
                                <option value="70x70mm">70x70mm</option>
                                <option value="custom">自定义</option>
                            </select>
                            <div id="customSizeInputs" style="display:none;">
                                <input type="number" id="customWidth" placeholder="宽度(mm)" min="10">
                                <input type="number" id="customHeight" placeholder="高度(mm)" min="10">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showProductNameOnTop">
                                品名独立显示在顶部
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>打印份数</label>
                            <input type="number" id="printCopies" value="1" min="1" max="10000">
                        </div>
                        
                        <div class="print-actions">
                            <button id="previewBtn" class="btn">预览</button>
                            <button id="printBtn" class="btn btn-primary">打印</button>
                        </div>
                    </div>
                    
                    <div class="preview-area">
                        <h4>预览区域</h4>
                        <div id="previewContent" class="preview-content">
                            <p>点击预览按钮查看标签效果</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 输入记忆下拉菜单 -->
    <div id="suggestionList" class="suggestion-list" style="display:none;"></div>
    
    <script src="renderer.js"></script>
</body>
</html>
</file>

<file path="main.js">
const { app, BrowserWindow, ipcMain, dialog, shell } = require('electron');
const path = require('path');
const fs = require('fs');
const PDFDocument = require('pdfkit');
const Store = require('electron-store');

const store = new Store();
let mainWindow;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    }
  });

  mainWindow.loadFile('index.html');
}

app.whenReady().then(() => {
  createWindow();
  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

// 获取打印机列表
ipcMain.handle('get-printers', async () => {
  const printers = await mainWindow.webContents.getPrintersAsync();
  return printers;
});

// 保存数据
ipcMain.handle('save-data', (event, key, value) => {
  store.set(key, value);
  return true;
});

// 获取数据
ipcMain.handle('get-data', (event, key) => {
  return store.get(key);
});

// 删除数据
ipcMain.handle('delete-data', (event, key) => {
  store.delete(key);
  return true;
});

// 获取所有标签
ipcMain.handle('get-all-labels', () => {
  return store.get('labels', []);
});

// 导出标签数据
ipcMain.handle('export-labels', async () => {
  const labels = store.get('labels', []);
  const { filePath } = await dialog.showSaveDialog({
    defaultPath: `labels_${new Date().toISOString().split('T')[0]}.json`,
    filters: [{ name: 'JSON', extensions: ['json'] }]
  });
  
  if (filePath) {
    fs.writeFileSync(filePath, JSON.stringify(labels, null, 2));
    return true;
  }
  return false;
});

// 导入标签数据
ipcMain.handle('import-labels', async () => {
  const { filePaths } = await dialog.showOpenDialog({
    filters: [{ name: 'JSON', extensions: ['json'] }],
    properties: ['openFile']
  });
  
  if (filePaths && filePaths.length > 0) {
    const data = fs.readFileSync(filePaths[0], 'utf8');
    const labels = JSON.parse(data);
    store.set('labels', labels);
    return labels;
  }
  return null;
});

// 生成PDF - 改进版，支持自适应布局
ipcMain.handle('generate-pdf', async (event, labelData, settings) => {
  const tempPath = path.join(app.getPath('temp'), `label_${Date.now()}.pdf`);
  
  // 设置纸张大小（转换mm到points）
  const mmToPoints = (mm) => mm * 2.83465;
  let width, height;
  
  if (settings.paperSize === 'custom' && settings.customWidth && settings.customHeight) {
    width = mmToPoints(parseFloat(settings.customWidth));
    height = mmToPoints(parseFloat(settings.customHeight));
  } else if (settings.paperSize === '70x70mm') {
    width = mmToPoints(70);
    height = mmToPoints(70);
  } else {
    // 默认 76x130mm
    width = mmToPoints(76);
    height = mmToPoints(130);
  }
  
  // 判断是否为小尺寸纸张
  const isSmallPaper = width < mmToPoints(75) && height < mmToPoints(75);
  
  // 根据纸张大小调整边距
  const margin = isSmallPaper ? mmToPoints(3) : mmToPoints(5);
  
  const doc = new PDFDocument({
    size: [width, height],
    margins: {
      top: margin,
      bottom: margin,
      left: margin,
      right: margin
    }
  });
  
  const stream = fs.createWriteStream(tempPath);
  doc.pipe(stream);
  
  // 注册中文字体
  try {
    if (process.platform === 'win32') {
      const fontPath = 'C:/Windows/Fonts/simhei.ttf';
      if (fs.existsSync(fontPath)) {
        doc.registerFont('Chinese', fontPath);
      }
    }
  } catch (e) {
    console.log('Font registration failed:', e);
  }
  
  // 可用区域
  const contentWidth = width - (margin * 2);
  const contentHeight = height - (margin * 2);
  let currentY = margin;
  
  // 根据纸张大小动态调整字体大小
  let baseFontSize;
  if (isSmallPaper) {
    baseFontSize = Math.min(8, contentWidth / 30);
  } else {
    baseFontSize = Math.min(12, contentWidth / 20);
  }
  
  // 如果品名要独立显示在顶部
  if (settings.showProductNameOnTop && labelData.productName) {
    doc.font('Chinese').fontSize(baseFontSize * 1.3)
       .text(labelData.productName, margin, currentY, {
         width: contentWidth,
         align: 'center'
       });
    currentY += baseFontSize * 1.8;
  }
  
  // 定义字段顺序和显示
  const fields = [
    { key: 'productName', label: '品名' },
    { key: 'ingredients', label: '配料' },
    { key: 'standardNo', label: '产品标准号' },
    { key: 'licenseNo', label: '生产许可证号' },
    { key: 'shelfLife', label: '保质期' },
    { key: 'productionDate', label: '生产日期' },
    { key: 'expiryDate', label: '保质期至' },
    { key: 'storageCondition', label: '贮存条件' },
    { key: 'netContent', label: '净含量' },
    { key: 'boxSpec', label: '箱规' },
    { key: 'origin', label: '产地' },
    { key: 'usage', label: '食用方法' },
    { key: 'manufacturer', label: '生产商' },
    { key: 'phone', label: '联系电话' },
    { key: 'address', label: '地址' },
    { key: 'allergen', label: '致敏物质提示' },
    { key: 'tips', label: '温馨提示' }
  ];
  
  doc.fontSize(baseFontSize);
  
  // 根据纸张大小选择布局方式
  if (isSmallPaper) {
    // 小纸张：紧凑布局，多个字段放在同一行
    let lineBuffer = [];
    let lineWidth = 0;
    const separator = '  '; // 两个空格分隔
    const separatorWidth = doc.widthOfString(separator);
    
    // 预留营养成分表空间（下1/3）
    const nutritionHeight = labelData.nutritionImage ? contentHeight * 0.33 : 0;
    const textAreaHeight = contentHeight - nutritionHeight;
    
    for (const field of fields) {
      if (labelData[field.key]) {
        // 跳过已经在顶部显示的品名
        if (settings.showProductNameOnTop && field.key === 'productName') {
          continue;
        }
        
        const text = `${field.label}：${labelData[field.key]}`;
        const textWidth = doc.widthOfString(text);
        
        // 判断是否需要换行
        if (lineWidth + textWidth + (lineBuffer.length > 0 ? separatorWidth : 0) > contentWidth || 
            // 某些字段强制独占一行
            ['ingredients', 'address', 'usage', 'tips', 'allergen'].includes(field.key)) {
          
          // 输出当前行
          if (lineBuffer.length > 0) {
            if (currentY < margin + textAreaHeight - baseFontSize) {
              doc.font('Chinese').text(lineBuffer.join(separator), margin, currentY, {
                width: contentWidth,
                align: 'left'
              });
              currentY += baseFontSize * 1.3;
            }
            lineBuffer = [];
            lineWidth = 0;
          }
          
          // 长文本字段独占行
          if (['ingredients', 'address', 'usage', 'tips', 'allergen'].includes(field.key)) {
            if (currentY < margin + textAreaHeight - baseFontSize) {
              const lines = doc.heightOfString(text, { width: contentWidth });
              doc.font('Chinese').text(text, margin, currentY, {
                width: contentWidth,
                align: 'left'
              });
              currentY += lines + 2;
            }
          } else {
            lineBuffer.push(text);
            lineWidth = textWidth;
          }
        } else {
          // 添加到当前行
          lineBuffer.push(text);
          lineWidth += textWidth + (lineBuffer.length > 1 ? separatorWidth : 0);
        }
      }
    }
    
    // 输出最后一行
    if (lineBuffer.length > 0 && currentY < margin + textAreaHeight - baseFontSize) {
      doc.font('Chinese').text(lineBuffer.join(separator), margin, currentY, {
        width: contentWidth,
        align: 'left'
      });
      currentY += baseFontSize * 1.3;
    }
    
    // 额外字段也采用紧凑布局
    if (labelData.extraFields && labelData.extraFields.length > 0) {
      lineBuffer = [];
      lineWidth = 0;
      
      for (const field of labelData.extraFields) {
        if (field.label && field.value) {
          const text = `${field.label}：${field.value}`;
          const textWidth = doc.widthOfString(text);
          
          if (lineWidth + textWidth + (lineBuffer.length > 0 ? separatorWidth : 0) > contentWidth) {
            if (lineBuffer.length > 0 && currentY < margin + textAreaHeight - baseFontSize) {
              doc.font('Chinese').text(lineBuffer.join(separator), margin, currentY, {
                width: contentWidth,
                align: 'left'
              });
              currentY += baseFontSize * 1.3;
              lineBuffer = [];
              lineWidth = 0;
            }
          }
          
          lineBuffer.push(text);
          lineWidth += textWidth + (lineBuffer.length > 1 ? separatorWidth : 0);
        }
      }
      
      if (lineBuffer.length > 0 && currentY < margin + textAreaHeight - baseFontSize) {
        doc.font('Chinese').text(lineBuffer.join(separator), margin, currentY, {
          width: contentWidth,
          align: 'left'
        });
        currentY += baseFontSize * 1.3;
      }
    }
    
  } else {
    // 大纸张：传统的一行一个字段布局
    for (const field of fields) {
      if (labelData[field.key]) {
        // 跳过已经在顶部显示的品名
        if (settings.showProductNameOnTop && field.key === 'productName') {
          continue;
        }
        
        const text = `${field.label}：${labelData[field.key]}`;
        const lines = doc.heightOfString(text, { width: contentWidth });
        
        // 检查是否超出页面
        if (currentY + lines > height - margin) {
          break;
        }
        
        doc.font('Chinese').text(text, margin, currentY, {
          width: contentWidth,
          align: 'left'
        });
        currentY += lines + 2;
      }
    }
    
    // 显示额外字段
    if (labelData.extraFields && labelData.extraFields.length > 0) {
      for (const field of labelData.extraFields) {
        if (field.label && field.value) {
          const text = `${field.label}：${field.value}`;
          const lines = doc.heightOfString(text, { width: contentWidth });
          
          if (currentY + lines > height - margin) {
            break;
          }
          
          doc.font('Chinese').text(text, margin, currentY, {
            width: contentWidth,
            align: 'left'
          });
          currentY += lines + 2;
        }
      }
    }
  }
  
  // 如果有营养成分表图片
  if (labelData.nutritionImage) {
    try {
      let imageY, imageHeight;
      
      if (isSmallPaper) {
        // 小纸张：确保图片在下1/3区域
        const nutritionAreaHeight = contentHeight * 0.33;
        const nutritionStartY = height - margin - nutritionAreaHeight;
        
        // 确保文字不会进入营养成分表区域
        if (currentY > nutritionStartY) {
          // 文字已经进入营养区域，需要调整
          console.log('Warning: Text overflow into nutrition area');
        }
        
        imageY = Math.max(nutritionStartY, currentY + 5); // 留5点间隔
        imageHeight = Math.min(nutritionAreaHeight - 5, height - margin - imageY);
      } else {
        // 大纸张：在文字下方显示
        const remainingHeight = height - margin - currentY;
        imageY = currentY + 5;
        imageHeight = Math.min(remainingHeight - 5, contentWidth * 0.8);
      }
      
      if (imageHeight > 10) {
        // 将base64转换为buffer
        const imageBuffer = Buffer.from(labelData.nutritionImage.split(',')[1], 'base64');
        doc.image(imageBuffer, margin, imageY, {
          width: contentWidth,
          height: imageHeight,
          fit: [contentWidth, imageHeight],
          align: 'center',
          valign: 'center'
        });
      }
    } catch (e) {
      console.error('Failed to add nutrition image:', e);
    }
  }
  
  doc.end();
  
  return new Promise((resolve) => {
    stream.on('finish', () => {
      resolve(tempPath);
    });
  });
});

// 打印PDF
ipcMain.handle('print-pdf', async (event, pdfPath, printerName, copies) => {
  try {
    if (process.platform === 'win32') {
      const ptp = require('pdf-to-printer');
      
      const options = {
        printer: printerName,
        copies: copies || 1,
        silent: true
      };
      
      await ptp.print(pdfPath, options);
      return { success: true };
    } else {
      const { exec } = require('child_process');
      const util = require('util');
      const execPromise = util.promisify(exec);
      
      let command;
      if (process.platform === 'darwin') {
        command = `lpr -P "${printerName}" -# ${copies || 1} "${pdfPath}"`;
      } else {
        command = `lp -d "${printerName}" -n ${copies || 1} "${pdfPath}"`;
      }
      
      await execPromise(command);
      return { success: true };
    }
  } catch (error) {
    console.error('Print error:', error);
    return { success: false, error: error.message };
  }
});

// 打开PDF预览
ipcMain.handle('preview-pdf', async (event, pdfPath) => {
  shell.openPath(pdfPath);
  return true;
});
</file>

<file path="package.json">
{
  "name": "label-printer",
  "version": "1.0.0",
  "description": "食品标签打印器",
  "main": "main.js",
  "scripts": {
    "start": "electron .",
    "build": "electron-builder",
    "dist": "electron-builder --publish=never"
  },
  "author": "",
  "license": "MIT",
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.9.1"
  },
  "dependencies": {
    "electron-store": "^8.1.0",
    "pdf-to-printer": "^5.6.0",
    "pdfkit": "^0.14.0"
  },
  "build": {
    "appId": "com.yourcompany.labelprinter",
    "productName": "标签打印器",
    "directories": {
      "output": "dist"
    },
    "win": {
      "target": "nsis",
      "icon": "assets/icon.ico"
    },
    "mac": {
      "target": "dmg",
      "icon": "assets/icon.icns"
    },
    "linux": {
      "target": "AppImage",
      "icon": "assets/icon.png"
    }
  }
}
</file>

<file path="preload.js">
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  // 打印机相关
  getPrinters: () => ipcRenderer.invoke('get-printers'),
  printPDF: (pdfPath, printerName, copies) => 
    ipcRenderer.invoke('print-pdf', pdfPath, printerName, copies),
  
  // PDF相关
  generatePDF: (labelData, settings) => 
    ipcRenderer.invoke('generate-pdf', labelData, settings),
  previewPDF: (pdfPath) => ipcRenderer.invoke('preview-pdf', pdfPath),
  
  // 数据存储
  saveData: (key, value) => ipcRenderer.invoke('save-data', key, value),
  getData: (key) => ipcRenderer.invoke('get-data', key),
  deleteData: (key) => ipcRenderer.invoke('delete-data', key),
  getAllLabels: () => ipcRenderer.invoke('get-all-labels'),
  
  // 导入导出
  exportLabels: () => ipcRenderer.invoke('export-labels'),
  importLabels: () => ipcRenderer.invoke('import-labels')
});
</file>

<file path="renderer.js">
// 全局变量
let labels = [];
let currentLabel = null;
let inputHistory = {};
let currentPdfPath = null;

// 保存标签 - 修复版
async function saveLabel(e) {
    if (e) {
        e.preventDefault(); // 阻止表单默认提交
        e.stopPropagation(); // 阻止事件冒泡
    }
    
    if (!currentLabel) return;
    
    try {
        // 收集表单数据
        currentLabel.productName = document.getElementById('productName').value;
        currentLabel.ingredients = document.getElementById('ingredients').value;
        currentLabel.standardNo = document.getElementById('standardNo').value;
        currentLabel.licenseNo = document.getElementById('licenseNo').value;
        currentLabel.shelfLifeType = document.getElementById('shelfLifeType').value;
        currentLabel.normalDays = document.getElementById('normalDays').value;
        currentLabel.frozenDays = document.getElementById('frozenDays').value;
        currentLabel.netContent = document.getElementById('netContent').value;
        currentLabel.boxSpec = document.getElementById('boxSpec').value;
        currentLabel.origin = document.getElementById('origin').value;
        currentLabel.usage = document.getElementById('usage').value;
        currentLabel.manufacturer = document.getElementById('manufacturer').value;
        currentLabel.phone = document.getElementById('phone').value;
        currentLabel.address = document.getElementById('address').value;
        currentLabel.allergen = document.getElementById('allergen').value;
        currentLabel.tips = document.getElementById('tips').value;
        currentLabel.extraFields = getExtraFields();
        
        // 更新保质期和贮存条件文本
        currentLabel.shelfLife = generateShelfLifeText(currentLabel);
        currentLabel.storageCondition = generateStorageCondition(currentLabel);
        
        // 保存到存储
        await saveLabelsToStorage();
        renderLabelList();
        
        // 保存输入历史
        await saveInputHistory();
        
        // 显示成功提示（使用非阻塞方式）
        showSuccessMessage('标签保存成功！');
        
    } catch (error) {
        console.error('保存标签时出错:', error);
        showSuccessMessage('保存失败：' + error.message);
    }
    
    // 返回false防止表单真的提交
    return false;
}

// 非阻塞的成功提示
function showSuccessMessage(message) {
    // 创建一个临时提示元素
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // 3秒后自动消失
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 2000);
}

// 设置事件监听器 - 修复版
function setupEventListeners() {
    // 搜索
    document.getElementById('searchInput').addEventListener('input', renderLabelList);
    
    // 新增标签
    document.getElementById('addLabelBtn').addEventListener('click', createNewLabel);
    
    // 导入导出
    document.getElementById('importBtn').addEventListener('click', importLabels);
    document.getElementById('exportBtn').addEventListener('click', exportLabels);
    
    // 保质期类型变化
    document.getElementById('shelfLifeType').addEventListener('change', updateShelfLifeInputs);
    
    // 纸张大小变化
    document.getElementById('paperSize').addEventListener('change', (e) => {
        const customInputs = document.getElementById('customSizeInputs');
        customInputs.style.display = e.target.value === 'custom' ? 'flex' : 'none';
    });
    
    // 营养成分表上传
    document.getElementById('nutritionImage').addEventListener('change', handleImageUpload);
    
    // 表单提交 - 修复这里！！！
    const labelForm = document.getElementById('labelForm');
    // 移除旧的监听器（如果有）
    labelForm.removeEventListener('submit', saveLabel);
    // 添加新的监听器
    labelForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        saveLabel(e);
        return false;
    }, false);
    
    // 删除标签
    document.getElementById('deleteLabelBtn').addEventListener('click', deleteCurrentLabel);
    
    // 添加额外字段
    document.getElementById('addExtraFieldBtn').addEventListener('click', addExtraField);
    
    // 预览和打印
    document.getElementById('previewBtn').addEventListener('click', previewLabel);
    document.getElementById('printBtn').addEventListener('click', printLabel);
    
    // 生产日期变化时更新保质期至
    document.getElementById('productionDate').addEventListener('change', updateExpiryDate);
}

// 确保DOM加载完成后初始化 - 重要！
document.addEventListener('DOMContentLoaded', async () => {
    await loadLabels();
    await loadPrinters();
    await loadInputHistory(); // 改为await确保加载完成
    
    // 先设置基础事件监听
    setupEventListeners();
    
    // 然后设置输入记忆（延迟一下确保DOM完全就绪）
    setTimeout(() => {
        setupInputMemory();
    }, 100);
    
    // 设置今天的日期为默认生产日期
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('productionDate').value = today;
    
    // 添加CSS动画
    if (!document.getElementById('toastAnimations')) {
        const style = document.createElement('style');
        style.id = 'toastAnimations';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
});

// 调试函数 - 检查输入框状态
function checkInputStatus() {
    const inputs = document.querySelectorAll('input, textarea, select');
    console.log('===== 输入框状态检查 =====');
    inputs.forEach(input => {
        console.log(`${input.id || input.name || 'unnamed'}: 
            disabled=${input.disabled}, 
            readonly=${input.readOnly}, 
            type=${input.type},
            listeners=${input.onclick ? 'has-onclick' : 'no-onclick'}`);
    });
    
    // 检查是否有遮罩层
    const suggestionList = document.getElementById('suggestionList');
    console.log('建议列表状态:', suggestionList.style.display, suggestionList.style.zIndex);
}

// 在控制台可以调用这个函数来调试
window.debugInputs = checkInputStatus;

// 加载标签列表
async function loadLabels() {
    labels = await window.electronAPI.getAllLabels() || [];
    renderLabelList();
}

// 渲染标签列表
function renderLabelList() {
    const labelList = document.getElementById('labelList');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    // 按品名排序
    const sortedLabels = [...labels].sort((a, b) => 
        (a.productName || '').localeCompare(b.productName || '', 'zh-CN')
    );
    
    // 过滤搜索结果
    const filteredLabels = sortedLabels.filter(label => 
        (label.productName || '').toLowerCase().includes(searchTerm)
    );
    
    labelList.innerHTML = '';
    
    filteredLabels.forEach((label, index) => {
        const item = document.createElement('div');
        item.className = 'label-item';
        item.dataset.id = label.id;
        
        if (currentLabel && currentLabel.id === label.id) {
            item.classList.add('active');
        }
        
        item.innerHTML = `
            <div class="label-item-name">${label.productName || '未命名标签'}</div>
            <div class="label-item-info">${label.manufacturer || ''} ${label.netContent || ''}</div>
        `;
        
        item.addEventListener('click', () => selectLabel(label));
        labelList.appendChild(item);
    });
}

// 选择标签
function selectLabel(label) {
    currentLabel = label;
    
    // 更新列表选中状态
    document.querySelectorAll('.label-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === label.id) {
            item.classList.add('active');
        }
    });
    
    // 显示编辑器视图
    document.getElementById('welcomeView').style.display = 'none';
    document.getElementById('editorView').style.display = 'flex';
    
    // 填充表单
    fillForm(label);
    
    // 加载该标签的打印设置
    loadLabelSettings(label.id);
    
    // 清空预览
    document.getElementById('previewContent').innerHTML = '<p>点击预览按钮查看标签效果</p>';
}

// 填充表单
function fillForm(label) {
    document.getElementById('productName').value = label.productName || '';
    document.getElementById('ingredients').value = label.ingredients || '';
    document.getElementById('standardNo').value = label.standardNo || '';
    document.getElementById('licenseNo').value = label.licenseNo || '';
    document.getElementById('netContent').value = label.netContent || '';
    document.getElementById('boxSpec').value = label.boxSpec || '';
    document.getElementById('origin').value = label.origin || '';
    document.getElementById('usage').value = label.usage || '';
    document.getElementById('manufacturer').value = label.manufacturer || '';
    document.getElementById('phone').value = label.phone || '';
    document.getElementById('address').value = label.address || '';
    document.getElementById('allergen').value = label.allergen || '';
    document.getElementById('tips').value = label.tips || '';
    
    // 保质期类型
    document.getElementById('shelfLifeType').value = label.shelfLifeType || 'normal';
    updateShelfLifeInputs();
    
    if (label.normalDays) {
        document.getElementById('normalDays').value = label.normalDays;
    }
    if (label.frozenDays) {
        document.getElementById('frozenDays').value = label.frozenDays;
    }
    
    // 营养成分表图片
    if (label.nutritionImage) {
        const preview = document.getElementById('nutritionPreview');
        preview.innerHTML = `<img src="${label.nutritionImage}" alt="营养成分表">`;
    } else {
        document.getElementById('nutritionPreview').innerHTML = '';
    }
    
    // 额外字段
    renderExtraFields(label.extraFields || []);
}

// 渲染额外字段
function renderExtraFields(fields) {
    const container = document.getElementById('extraFields');
    container.innerHTML = '';
    
    fields.forEach((field, index) => {
        const div = document.createElement('div');
        div.className = 'extra-field';
        div.innerHTML = `
            <input type="text" placeholder="字段名称" value="${field.label || ''}" data-field="label">
            <input type="text" placeholder="字段值" value="${field.value || ''}" data-field="value">
            <button type="button" class="btn btn-small" onclick="removeExtraField(${index})">删除</button>
        `;
        container.appendChild(div);
    });
}

// 添加额外字段
function addExtraField() {
    const container = document.getElementById('extraFields');
    const div = document.createElement('div');
    div.className = 'extra-field';
    div.innerHTML = `
        <input type="text" placeholder="字段名称" data-field="label">
        <input type="text" placeholder="字段值" data-field="value">
        <button type="button" class="btn btn-small" onclick="removeExtraField(this)">删除</button>
    `;
    container.appendChild(div);
}

// 删除额外字段
function removeExtraField(indexOrElement) {
    if (typeof indexOrElement === 'number') {
        renderExtraFields(getExtraFields().filter((_, i) => i !== indexOrElement));
    } else {
        indexOrElement.parentElement.remove();
    }
}

// 获取额外字段数据
function getExtraFields() {
    const fields = [];
    document.querySelectorAll('#extraFields .extra-field').forEach(field => {
        const label = field.querySelector('[data-field="label"]').value;
        const value = field.querySelector('[data-field="value"]').value;
        if (label || value) {
            fields.push({ label, value });
        }
    });
    return fields;
}



// 更新保质期输入框
function updateShelfLifeInputs() {
    const type = document.getElementById('shelfLifeType').value;
    const normalDays = document.getElementById('normalDays');
    const frozenDays = document.getElementById('frozenDays');
    
    switch(type) {
        case 'dual':
            normalDays.style.display = 'block';
            frozenDays.style.display = 'block';
            normalDays.placeholder = '常温天数';
            break;
        case 'frozen':
            normalDays.style.display = 'none';
            frozenDays.style.display = 'block';
            frozenDays.placeholder = '冷冻天数';
            break;
        default:
            normalDays.style.display = 'block';
            frozenDays.style.display = 'none';
            normalDays.placeholder = '保质天数';
    }
}

// 处理图片上传
function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
        const preview = document.getElementById('nutritionPreview');
        preview.innerHTML = `<img src="${event.target.result}" alt="营养成分表">`;
        
        // 保存到当前标签
        if (currentLabel) {
            currentLabel.nutritionImage = event.target.result;
        }
    };
    reader.readAsDataURL(file);
}

// 创建新标签
function createNewLabel() {
    const label = {
        id: Date.now().toString(),
        productName: '新标签',
        createdAt: new Date().toISOString()
    };
    
    labels.push(label);
    saveLabelsToStorage();
    renderLabelList();
    selectLabel(label);
}



// 生成保质期文本
function generateShelfLifeText(label) {
    const type = label.shelfLifeType;
    const normal = label.normalDays;
    const frozen = label.frozenDays;
    
    switch(type) {
        case 'normalWithCold':
            return `常温${normal}天，开封后需冷藏`;
        case 'normalWithFrozen':
            return `常温${normal}天，开封后需冷冻`;
        case 'frozen':
            return `冷冻${frozen}天`;
        case 'dual':
            return `常温${normal}天，冷冻${frozen}天`;
        default:
            return `${normal}天`;
    }
}

// 生成贮存条件
function generateStorageCondition(label) {
    const type = label.shelfLifeType;
    
    switch(type) {
        case 'normalWithCold':
            return '常温保存，开封后需冷藏';
        case 'normalWithFrozen':
            return '常温保存，开封后需冷冻';
        case 'frozen':
            return '冷冻保存（≤-18℃）';
        case 'dual':
            return '常温保存或冷冻保存（≤-18℃）';
        default:
            return '常温保存，避免阳光直射';
    }
}

// 删除当前标签
async function deleteCurrentLabel() {
    if (!currentLabel) return;
    
    if (!window.confirm(`确定要删除标签"${currentLabel.productName}"吗？`)) {
        return;
    }
    
    labels = labels.filter(l => l.id !== currentLabel.id);
    saveLabelsToStorage();
    
    currentLabel = null;
    document.getElementById('welcomeView').style.display = 'flex';
    document.getElementById('editorView').style.display = 'none';
    
    renderLabelList();
}

// 保存标签到存储
async function saveLabelsToStorage() {
    await window.electronAPI.saveData('labels', labels);
}

// 加载打印机列表
async function loadPrinters() {
    const printers = await window.electronAPI.getPrinters();
    const select = document.getElementById('printerSelect');
    
    select.innerHTML = '<option value="">选择打印机...</option>';
    printers.forEach(printer => {
        const option = document.createElement('option');
        option.value = printer.name;
        option.textContent = printer.displayName || printer.name;
        if (printer.isDefault) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

// 加载标签设置
async function loadLabelSettings(labelId) {
    const settings = await window.electronAPI.getData(`labelSettings_${labelId}`) || {};
    
    if (settings.paperSize) {
        document.getElementById('paperSize').value = settings.paperSize;
        if (settings.paperSize === 'custom') {
            document.getElementById('customSizeInputs').style.display = 'flex';
            document.getElementById('customWidth').value = settings.customWidth || '';
            document.getElementById('customHeight').value = settings.customHeight || '';
        }
    }
    
    if (settings.showProductNameOnTop !== undefined) {
        document.getElementById('showProductNameOnTop').checked = settings.showProductNameOnTop;
    }
    
    // 加载上次的生产日期
    const lastProductionDate = await window.electronAPI.getData('lastProductionDate');
    if (lastProductionDate) {
        document.getElementById('productionDate').value = lastProductionDate;
    }
}

// 保存标签设置
async function saveLabelSettings() {
    if (!currentLabel) return;
    
    const settings = {
        paperSize: document.getElementById('paperSize').value,
        customWidth: document.getElementById('customWidth').value,
        customHeight: document.getElementById('customHeight').value,
        showProductNameOnTop: document.getElementById('showProductNameOnTop').checked
    };
    
    await window.electronAPI.saveData(`labelSettings_${currentLabel.id}`, settings);
    
    // 保存生产日期
    const productionDate = document.getElementById('productionDate').value;
    if (productionDate) {
        await window.electronAPI.saveData('lastProductionDate', productionDate);
    }
}

// 更新保质期至日期
function updateExpiryDate() {
    if (!currentLabel) return;
    
    const productionDate = document.getElementById('productionDate').value;
    if (!productionDate) return;
    
    const date = new Date(productionDate);
    let expiryText = '';
    
    const type = currentLabel.shelfLifeType;
    const normal = parseInt(currentLabel.normalDays);
    const frozen = parseInt(currentLabel.frozenDays);
    
    if (type === 'dual' && normal && frozen) {
        const normalExpiry = new Date(date);
        normalExpiry.setDate(normalExpiry.getDate() + normal);
        const frozenExpiry = new Date(date);
        frozenExpiry.setDate(frozenExpiry.getDate() + frozen);
        
        expiryText = `常温${formatDate(normalExpiry)}，冷冻${formatDate(frozenExpiry)}`;
    } else if (type === 'frozen' && frozen) {
        const expiry = new Date(date);
        expiry.setDate(expiry.getDate() + frozen);
        expiryText = formatDate(expiry);
    } else if (normal) {
        const expiry = new Date(date);
        expiry.setDate(expiry.getDate() + normal);
        expiryText = formatDate(expiry);
    }
    
    currentLabel.expiryDate = expiryText;
    return expiryText;
}

// 格式化日期
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}年${month}月${day}日`;
}

// 生成预览HTML - 改进版，支持自适应布局
function generatePreviewHTML(labelData, settings) {
    let html = '';
    
    // 判断是否为小尺寸纸张
    const isSmallPaper = settings.paperSize === '70x70mm' || 
                         (settings.paperSize === 'custom' && 
                          parseFloat(settings.customWidth) < 75 && 
                          parseFloat(settings.customHeight) < 75);
    
    // 设置容器样式
    if (isSmallPaper) {
        html = '<div style="font-size:10px;line-height:1.3;">';
    } else {
        html = '<div style="font-size:12px;line-height:1.6;">';
    }
    
    // 如果品名要独立显示在顶部
    if (settings.showProductNameOnTop && labelData.productName) {
        const titleSize = isSmallPaper ? '13px' : '16px';
        html += `<div style="text-align:center;font-size:${titleSize};font-weight:bold;margin-bottom:8px;">${labelData.productName}</div>`;
    }
    
    // 定义字段顺序
    const fields = [
        { key: 'productName', label: '品名' },
        { key: 'ingredients', label: '配料' },
        { key: 'standardNo', label: '产品标准号' },
        { key: 'licenseNo', label: '生产许可证号' },
        { key: 'shelfLife', label: '保质期' },
        { key: 'productionDate', label: '生产日期' },
        { key: 'expiryDate', label: '保质期至' },
        { key: 'storageCondition', label: '贮存条件' },
        { key: 'netContent', label: '净含量' },
        { key: 'boxSpec', label: '箱规' },
        { key: 'origin', label: '产地' },
        { key: 'usage', label: '食用方法' },
        { key: 'manufacturer', label: '生产商' },
        { key: 'phone', label: '联系电话' },
        { key: 'address', label: '地址' },
        { key: 'allergen', label: '致敏物质提示' },
        { key: 'tips', label: '温馨提示' }
    ];
    
    if (isSmallPaper) {
        // 小纸张：紧凑布局
        let lineBuffer = [];
        const longFields = ['ingredients', 'address', 'usage', 'tips', 'allergen'];
        
        html += '<div style="word-wrap:break-word;word-break:break-all;">';
        
        for (const field of fields) {
            if (labelData[field.key]) {
                // 跳过已经在顶部显示的品名
                if (settings.showProductNameOnTop && field.key === 'productName') {
                    continue;
                }
                
                const fieldContent = `<span><strong>${field.label}：</strong>${labelData[field.key]}</span>`;
                
                // 长文本字段独占一行
                if (longFields.includes(field.key)) {
                    // 先输出缓冲区内容
                    if (lineBuffer.length > 0) {
                        html += '<div>' + lineBuffer.join('&nbsp;&nbsp;') + '</div>';
                        lineBuffer = [];
                    }
                    // 输出长文本字段
                    html += `<div>${fieldContent}</div>`;
                } else {
                    // 短字段添加到缓冲区
                    lineBuffer.push(fieldContent);
                    
                    // 每3个短字段换行（可根据实际宽度调整）
                    if (lineBuffer.length >= 2 || 
                        // 某些字段后强制换行
                        ['expiryDate', 'storageCondition', 'phone'].includes(field.key)) {
                        html += '<div>' + lineBuffer.join('&nbsp;&nbsp;') + '</div>';
                        lineBuffer = [];
                    }
                }
            }
        }
        
        // 输出剩余的缓冲区内容
        if (lineBuffer.length > 0) {
            html += '<div style="margin-bottom:2px;">' + lineBuffer.join('&nbsp;&nbsp;') + '</div>';
        }
        
        // 额外字段也采用紧凑布局（同样需要防溢出）
        if (labelData.extraFields && labelData.extraFields.length > 0) {
            lineBuffer = [];
            for (const field of labelData.extraFields) {
                if (field.label && field.value) {
                    let value = field.value;
                    // 截断超长的额外字段值
                    if (value.length > 50) {
                        value = value.substring(0, 47) + '...';
                    }
                    lineBuffer.push(`<span><strong>${field.label}：</strong>${value}</span>`);
                    if (lineBuffer.length >= 2) {
                        html += '<div style="margin-bottom:2px;">' + lineBuffer.join('&nbsp;&nbsp;') + '</div>';
                        lineBuffer = [];
                    }
                }
            }
            if (lineBuffer.length > 0) {
                html += '<div style="margin-bottom:2px;">' + lineBuffer.join('&nbsp;&nbsp;') + '</div>';
            }
        }
        
        html += '</div>';
        
        // 营养成分表 - 小尺寸，固定在底部1/3
        if (labelData.nutritionImage) {
            html += `<div style="position:relative;margin-top:5px;height:33%;max-height:120px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                       <img src="${labelData.nutritionImage}" style="width:100%;height:auto;max-height:100%;object-fit:contain;">
                     </div>`;
        }
        
    } else {
        // 大纸张：传统布局
        for (const field of fields) {
            if (labelData[field.key]) {
                if (settings.showProductNameOnTop && field.key === 'productName') {
                    continue;
                }
                html += `<div><strong>${field.label}：</strong>${labelData[field.key]}</div>`;
            }
        }
        
        // 额外字段
        if (labelData.extraFields && labelData.extraFields.length > 0) {
            labelData.extraFields.forEach(field => {
                if (field.label && field.value) {
                    html += `<div><strong>${field.label}：</strong>${field.value}</div>`;
                }
            });
        }
        
        // 营养成分表 - 正常尺寸
        if (labelData.nutritionImage) {
            html += `<div style="margin-top:10px;">
                       <img src="${labelData.nutritionImage}" style="max-width:100%;">
                     </div>`;
        }
    }
    
    html += '</div>';
    return html;
}

// 同时更新预览区域的样式以适应不同纸张
function updatePreviewAreaStyle(settings) {
    const previewContent = document.getElementById('previewContent');
    
    // 判断是否为小尺寸纸张
    const isSmallPaper = settings.paperSize === '70x70mm' || 
                         (settings.paperSize === 'custom' && 
                          parseFloat(settings.customWidth) < 75 && 
                          parseFloat(settings.customHeight) < 75);
    
    if (isSmallPaper) {
        // 小纸张预览样式
        previewContent.style.minHeight = '300px';
        previewContent.style.maxHeight = '400px';
        previewContent.style.padding = '10px';
        previewContent.className = 'preview-content preview-content-small';
    } else {
        // 正常纸张预览样式
        previewContent.style.minHeight = '400px';
        previewContent.style.maxHeight = '600px';
        previewContent.style.padding = '15px';
        previewContent.className = 'preview-content';
    }
}

// 预览标签 - 更新版
async function previewLabel() {
    if (!currentLabel) {
        showSuccessMessage('请先选择一个标签');
        return;
    }
    
    const productionDate = document.getElementById('productionDate').value;
    if (!productionDate) {
        showSuccessMessage('请输入生产日期');
        return;
    }
    
    // 保存设置
    await saveLabelSettings();
    
    // 准备标签数据
    const labelData = {
        ...currentLabel,
        productionDate: formatDate(new Date(productionDate)),
        expiryDate: updateExpiryDate()
    };
    
    // 获取打印设置
    const settings = {
        paperSize: document.getElementById('paperSize').value,
        customWidth: document.getElementById('customWidth').value,
        customHeight: document.getElementById('customHeight').value,
        showProductNameOnTop: document.getElementById('showProductNameOnTop').checked
    };
    
    // 更新预览区域样式
    updatePreviewAreaStyle(settings);
    
    // 生成PDF
    currentPdfPath = await window.electronAPI.generatePDF(labelData, settings);
    
    // 显示预览内容
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = generatePreviewHTML(labelData, settings);
}

// 打印标签
async function printLabel() {
    if (!currentLabel) {
        showSuccessMessage('请先选择一个标签');
        return;
    }
    
    const productionDate = document.getElementById('productionDate').value;
    if (!productionDate) {
        showSuccessMessage('请输入生产日期');
        return;
    }
    
    const printer = document.getElementById('printerSelect').value;
    if (!printer) {
        showSuccessMessage('请选择打印机');
        return;
    }
    
    const copies = parseInt(document.getElementById('printCopies').value) || 1;
    
    try {
        // 禁用打印按钮，防止重复点击
        const printBtn = document.getElementById('printBtn');
        printBtn.disabled = true;
        printBtn.textContent = '打印中...';
        
        // 如果还没有生成PDF，先生成
        if (!currentPdfPath) {
            await previewLabel();
        }
        
        // 打印
        const result = await window.electronAPI.printPDF(currentPdfPath, printer, copies);
        
        if (result.success) {
            showSuccessMessage(`成功发送到打印机，共${copies}份`);
        } else {
            showSuccessMessage(`打印失败：${result.error || '未知错误'}`);
        }
    } catch (error) {
        console.error('打印出错:', error);
        showSuccessMessage('打印过程中出现错误，请重试');
    } finally {
        // 恢复打印按钮
        const printBtn = document.getElementById('printBtn');
        printBtn.disabled = false;
        printBtn.textContent = '打印';
        
        // 确保建议列表被隐藏
        hideSuggestions();
        
        // 重新聚焦到当前活动元素，防止焦点丢失
        if (document.activeElement && document.activeElement.tagName === 'BUTTON') {
            document.activeElement.blur();
        }
    }
}

// 导入标签
async function importLabels() {
    const imported = await window.electronAPI.importLabels();
    if (imported) {
        labels = imported;
        renderLabelList();
        showSuccessMessage('导入成功！');
    }
}

// 导出标签
async function exportLabels() {
    const success = await window.electronAPI.exportLabels();
    if (success) {
        showSuccessMessage('导出成功！');
    }
}

// 输入记忆功能
function setupInputMemory() {
    const inputs = document.querySelectorAll('input[type="text"], textarea');
    
    inputs.forEach(input => {
        // 获取输入历史
        input.addEventListener('focus', (e) => {
            showSuggestions(e.target);
        });
        
        // 更新输入历史 - 修改blur事件处理
        input.addEventListener('blur', (e) => {
            // 延迟执行，给点击建议项留出时间
            setTimeout(() => {
                updateInputHistory(e.target.id, e.target.value);
                hideSuggestions();
            }, 250);
        });
        
        // 键盘导航
        input.addEventListener('keydown', (e) => {
            handleSuggestionNavigation(e);
        });
        
        // 添加input事件监听，实时更新建议
        input.addEventListener('input', (e) => {
            showSuggestions(e.target);
        });
    });
    
    // 全局点击事件，点击其他地方时隐藏建议列表
    document.addEventListener('click', (e) => {
        const suggestionList = document.getElementById('suggestionList');
        const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
        const isSuggestion = e.target.classList.contains('suggestion-item');
        
        if (!isInput && !isSuggestion) {
            hideSuggestions();
        }
    });
}

// 显示建议列表
function showSuggestions(input) {
    // 确保输入框没有被禁用
    if (input.disabled || input.readOnly) {
        return;
    }
    
    const fieldId = input.id;
    if (!fieldId) return; // 没有ID的输入框不显示建议
    
    const history = inputHistory[fieldId] || [];
    const currentValue = input.value.toLowerCase();
    
    const filtered = history.filter(item => 
        item && item.toLowerCase().includes(currentValue)
    );
    
    const suggestionList = document.getElementById('suggestionList');
    
    if (filtered.length === 0) {
        hideSuggestions();
        return;
    }
    
    suggestionList.innerHTML = '';
    
    filtered.slice(0, 10).forEach((item, index) => { // 限制最多显示10个建议
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = item;
        div.dataset.index = index;
        
        // 使用mousedown而不是click，避免blur事件冲突
        div.addEventListener('mousedown', (e) => {
            e.preventDefault(); // 阻止默认行为，防止输入框失去焦点
            input.value = item;
            hideSuggestions();
            // 触发input事件，以便其他监听器能够响应
            input.dispatchEvent(new Event('input', { bubbles: true }));
        });
        
        suggestionList.appendChild(div);
    });
    
    // 定位建议列表
    const rect = input.getBoundingClientRect();
    suggestionList.style.left = rect.left + 'px';
    suggestionList.style.top = (rect.bottom + 2) + 'px';
    suggestionList.style.width = rect.width + 'px';
    suggestionList.style.display = 'block';
    
    // 确保建议列表不会超出视窗
    const listRect = suggestionList.getBoundingClientRect();
    if (listRect.bottom > window.innerHeight) {
        suggestionList.style.top = (rect.top - listRect.height - 2) + 'px';
    }
}


// 隐藏建议列表
function hideSuggestions() {
    const suggestionList = document.getElementById('suggestionList');
    if (suggestionList) {
        suggestionList.style.display = 'none';
        suggestionList.innerHTML = ''; // 清空内容，避免残留
    }
}

// 处理建议列表键盘导航
function handleSuggestionNavigation(e) {
    const suggestionList = document.getElementById('suggestionList');
    if (!suggestionList || suggestionList.style.display === 'none') return;
    
    const items = suggestionList.querySelectorAll('.suggestion-item');
    if (items.length === 0) return;
    
    const selected = suggestionList.querySelector('.selected');
    let index = selected ? parseInt(selected.dataset.index) : -1;
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            index = (index + 1) % items.length;
            break;
        case 'ArrowUp':
            e.preventDefault();
            index = index <= 0 ? items.length - 1 : index - 1;
            break;
        case 'Enter':
            if (selected) {
                e.preventDefault();
                e.target.value = selected.textContent;
                hideSuggestions();
                // 触发input事件
                e.target.dispatchEvent(new Event('input', { bubbles: true }));
            }
            return;
        case 'Escape':
            e.preventDefault();
            hideSuggestions();
            return;
        case 'Tab':
            // Tab键时隐藏建议
            hideSuggestions();
            return;
        default:
            return;
    }
    
    items.forEach(item => item.classList.remove('selected'));
    if (items[index]) {
        items[index].classList.add('selected');
        // 确保选中项可见
        items[index].scrollIntoView({ block: 'nearest' });
    }
}

// 加载输入历史
async function loadInputHistory() {
    inputHistory = await window.electronAPI.getData('inputHistory') || {};
}

// 保存输入历史
async function saveInputHistory() {
    await window.electronAPI.saveData('inputHistory', inputHistory);
}

// 更新输入历史
function updateInputHistory(fieldId, value) {
    if (!value || !fieldId || value.trim() === '') return;
    
    if (!inputHistory[fieldId]) {
        inputHistory[fieldId] = [];
    }
    
    // 移除重复项
    inputHistory[fieldId] = inputHistory[fieldId].filter(item => item !== value);
    
    // 添加到开头
    inputHistory[fieldId].unshift(value);
    
    // 限制历史记录数量
    if (inputHistory[fieldId].length > 20) { // 增加到20条
        inputHistory[fieldId] = inputHistory[fieldId].slice(0, 20);
    }
    
    // 异步保存，避免阻塞
    setTimeout(() => {
        saveInputHistory();
    }, 100);
}
</file>

<file path="repomix.config.json">
{
  "output": {
    "filePath": "repomix-output.txt",
    "style": "xml",
    "parsableStyle": false,
    "fileSummary": true,
    "directoryStructure": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "compress": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "copyToClipboard": false,
    "git": {
      "sortByChanges": true,
      "sortByChangesMaxCommits": 100
    }
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "o200k_base"
  }
}
</file>

<file path="style.css">
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
    background: #f5f5f5;
    color: #333;
    height: 100vh;
    overflow: hidden;
}

.container {
    display: flex;
    height: 100vh;
}

/* 左侧边栏 */
.sidebar {
    width: 300px;
    background: white;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.sidebar-header h2 {
    margin-bottom: 15px;
    font-size: 20px;
}

.sidebar-actions {
    display: flex;
    gap: 10px;
}

.search-box {
    padding: 15px 20px;
    border-bottom: 1px solid #e0e0e0;
}

.search-box input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.label-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.label-item {
    padding: 12px 15px;
    margin-bottom: 5px;
    background: #f8f8f8;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.label-item:hover {
    background: #e8e8e8;
}

.label-item.active {
    background: #007bff;
    color: white;
}

.label-item-name {
    font-weight: 500;
    margin-bottom: 4px;
}

.label-item-info {
    font-size: 12px;
    opacity: 0.7;
}

/* 主内容区 */
.main-content {
    flex: 1;
    display: flex;
    background: white;
}

.welcome-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 40px;
}

.welcome-view h2 {
    margin-bottom: 20px;
    font-size: 28px;
    color: #555;
}

.welcome-view p {
    font-size: 16px;
    color: #888;
}

.editor-view {
    flex: 1;
    display: flex;
    height: 100vh;
}

/* 编辑面板 */
.editor-panel {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
    border-right: 1px solid #e0e0e0;
}

.editor-panel h3 {
    margin-bottom: 20px;
    font-size: 18px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 14px;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group textarea {
    resize: vertical;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.shelf-life-inputs {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.shelf-life-inputs input {
    flex: 1;
}

.image-preview {
    margin-top: 10px;
    max-width: 300px;
}

.image-preview img {
    max-width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
}

/* 额外字段 */
.extra-field {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.extra-field input {
    flex: 1;
}

.extra-field button {
    padding: 5px 10px;
}

/* 预览面板 */
.preview-panel {
    width: 400px;
    padding: 30px;
    display: flex;
    flex-direction: column;
}

.preview-panel h3 {
    margin-bottom: 20px;
    font-size: 18px;
}

.print-settings {
    margin-bottom: 30px;
}

#customSizeInputs {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

#customSizeInputs input {
    flex: 1;
}

.print-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.print-actions button {
    flex: 1;
}

.preview-area {
    flex: 1;
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 20px;
    background: #fafafa;
    overflow: auto;
}

.preview-area h4 {
    margin-bottom: 15px;
    font-size: 16px;
    text-align: center;
}

.preview-content {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    min-height: 300px;
    font-size: 12px;
    line-height: 1.6;
}

.preview-content p {
    text-align: center;
    color: #999;
    margin-top: 100px;
}

/* 按钮样式 */
.btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    color: #333;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn:hover {
    background: #f8f8f8;
}

.btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

/* 输入建议列表 */
.suggestion-list {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
}

.suggestion-item:hover {
    background: #f0f0f0;
}

.suggestion-item.selected {
    background: #007bff;
    color: white;
}

/* 滚动条样式 */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* 响应式调整 */
@media (max-width: 1200px) {
    .preview-panel {
        width: 350px;
    }
}

@media (max-width: 1000px) {
    .sidebar {
        width: 250px;
    }
}

/* 小纸张预览样式 */
.preview-content-small {
    font-size: 10px !important;
    line-height: 1.3 !important;
}

.preview-content-small strong {
    font-weight: 600;
}

.preview-content-small div {
    margin-bottom: 2px;
}

.preview-content-small span {
    display: inline-block;
    margin-right: 8px;
}

/* 自适应预览容器 */
.preview-content[data-paper-size="small"] {
    transform: scale(0.8);
    transform-origin: top left;
}

/* 打印设置响应式调整 */
@media print {
    .preview-content-small {
        font-size: 8px !important;
        line-height: 1.2 !important;
    }
}

/* 营养成分表图片自适应 */
.preview-content img {
    object-fit: contain;
    display: block;
    margin: 0 auto;
}

/* 确保建议列表不会阻挡输入 */
.suggestion-list {
    pointer-events: none;
}
.suggestion-list[style*="display: block"] {
    pointer-events: auto;
}
</file>

</files>
